---
name: main-packer-dev

on:
  push:
    branches:
      - main
    paths:
      - environments/packer-dev/**
      - .github/workflows/main-packer-dev.yaml
  pull_request:
    branches:
      - main
    paths:
      - environments/packer-dev/**
      - .github/workflows/main-packer-dev.yaml
  workflow_dispatch:

concurrency:
  group: packer-net-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform-net-plan:
    name: Terraform plan (packer networking)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    needs: packer-validate-built

    defaults:
      run:
        shell: bash
        working-directory: environments/packer-dev/terraform-net

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Si tu repo ya tiene auth OIDC a GCP, mete aquí tu bloque existente.
      # Ejemplo típico (descomentarlo y completar con tu provider/SA):
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      - name: Terraform init
        run: terraform init

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan (no apply)
        env:
          TF_VAR_project_id: ${{ vars.GCP_INFRA_PROJECT_ID }}
          TF_VAR_region: ${{ vars.GCP_INFRA_REGION }}
          # Si también pasas vpc/subnet/cidr por variables del repo, añade aquí:
          TF_VAR_vpc_name: ${{ vars.GCP_INFRA_NETWORK }}
          TF_VAR_subnet_name: ${{ vars.GCP_INFRA_SUBNETWORK }}
          # TF_VAR_subnet_cidr: ${{ vars.GCP_INFRA_SUBNET_CIDR }}
          # TF_VAR_iap_ssh_tag:  ${{ vars.GCP_INFRA_IAP_SSH_TAG }}
        run: terraform plan -no-color -out=tfplan.bin

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.sha }}
          path: |
            environments/packer-dev/terraform-net/tfplan.bin
          retention-days: 7


  terraform-apply-net:
    name: Terraform apply (packer networking)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs:
      - terraform-net-plan
      - packer-validate-built
    permissions:
      contents: read
      id-token: write
    environment: devk3s
    defaults:
      run:
        shell: bash
        working-directory: environments/packer-dev/terraform-net
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.sha }}
          path: ./plan

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"
          terraform_wrapper: false

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform-apply
        run: terraform apply -input=false -auto-approve ./plan/tfplan.bin

      - name: Export VM outputs
        id: export_vm
        run: |
          VM_NAME=$(terraform output -raw vm_name)
          VM_IP=$(terraform output -raw vm_internal_ip)
          echo "vm_name=$VM_NAME" >> "$GITHUB_OUTPUT"
          echo "vm_ip=$VM_IP" >> "$GITHUB_OUTPUT"

      - name: Save Terraform outputs
        run: terraform output -json > tfoutputs.json

      - name: Upload TF outputs
        uses: actions/upload-artifact@v4
        with:
          name: tfoutputs-${{ github.sha }}
          path: tfoutputs.json
          retention-days: 7


  packer-validate-built:
    name: Packer validate (IAP, built)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        shell: bash
        working-directory: environments/packer-dev/gcp-ubuntu-2204-iap

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: {fetch-depth: 0}

      # Igual que arriba: usar auth OIDC real si lo tienes ya.
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_PACKER_SERVICE }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Packer init
        run: packer init .

      - name: Packer fmt (check)
        run: packer fmt .

      - name: Packer validate
        env:
          PKR_VAR_project_id: ${{ vars.GCP_INFRA_PROJECT_ID }}
          PKR_VAR_region: ${{ vars.GCP_INFRA_REGION }}
          PKR_VAR_zone: ${{ vars.GCP_INFRA_ZONE }}
          PKR_VAR_service_account_email: ${{ vars.GCP_PACKER_SERVICE }}
          PKR_VAR_network: ${{ vars.GCP_INFRA_NETWORK }}
          PKR_VAR_subnetwork: ${{ vars.GCP_INFRA_SUBNETWORK }}
          # Opcionales si quieres sobreescribir defaults:
          # PKR_VAR_image_family: "ubuntu-2204-iap-family"
          # PKR_VAR_iap_ssh_tag:  "iap-ssh"
        run: packer validate .

      - name: Packer build (IAP, built)
        env:
          PKR_VAR_project_id: ${{ vars.GCP_INFRA_PROJECT_ID }}
          PKR_VAR_region: ${{ vars.GCP_INFRA_REGION }}
          PKR_VAR_zone: ${{ vars.GCP_INFRA_ZONE }}
          PKR_VAR_service_account_email: ${{ vars.GCP_PACKER_SERVICE }}
          PKR_VAR_network: ${{ vars.GCP_INFRA_NETWORK }}
          PKR_VAR_subnetwork: ${{ vars.GCP_INFRA_SUBNETWORK }}
        run: packer build .

  cilium-installer:
    name: Cilium installer
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs:
      - terraform-apply-net
      - packer-validate-built

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
      
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup helm
        uses: azure/setup-helm@v4

      - name: Download TF outputs
        uses: actions/download-artifact@v4
        with:
          name: tfoutputs-${{ github.sha }}
          path: ./tfoutputs

      - name: Export VM info
        run: |
          VM_NAME=$(jq -r '.vm_name.value' ./tfoutputs/tfoutputs.json)
          echo "GCP_VM_NAME=${VM_NAME}" >> $GITHUB_ENV
          VM_IP=$(jq -r '.vm_internal_ip.value' ./tfoutputs/tfoutputs.json)
          echo "GCP_VM_IP=${VM_IP}" >> $GITHUB_ENV

      - name: Fetch k3s kubeconfig via IAP
        env:
          PROJECT: ${{ vars.GCP_INFRA_PROJECT_ID }}
          ZONE: ${{ vars.GCP_INFRA_ZONE }}
          VM_NAME: ${{ env.GCP_VM_NAME }}
        run: |
          set -euo pipefail
          gcloud compute ssh "$VM_NAME" \
            --tunnel-through-iap \
            --project "${PROJECT}" \
            --zone "${ZONE}" \
            --command "sudo cat /etc/rancher/k3s/k3s.yaml" \
            --impersonate-service-account="${{ vars.GCP_SERVICE_ACCOUNT }}" \
            > k3s.yaml
          INTERNAL_IP=$(gcloud compute instances describe "${VM_NAME}" --project "${PROJECT}" --zone "${ZONE}" --format='get(networkInterfaces[0].networkIP)')
          sed -i "s/127.0.0.1/${INTERNAL_IP}/g" k3s.yaml
          echo "KUBECONFIG=$(pwd)/k3s.yaml" >> $GITHUB_ENV

      - name: Install cilium
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          set -euo pipefail
          helm repo add cilium https://helm.cilium.io
          helm repo update
          API_HOST=$(grep server: "$KUBECONFIG" | head -1 | awk '{print $2}' | sed 's#https://##' | cut -d: -f1)
          helm install cilium cilium/cilium \
            --namespace kube-system \
            --set kubeProxyReplacement=strict \
            --set k8sServiceHost="${API_HOST}" \
            --set k8sServicePort=6443 \
            --set ingressController.enabled=true \
            --set ingressController.default=true

      - name: Install GCE PD CSI
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          set -euo pipefail
          helm repo add gcp-filestore https://kubernetes-sigs.github.io/gcp-compute-persistent-disk-csi-driver/
          helm repo update
          helm install gcp-pd-csi gcp-filestore/gcp-compute-persistent-disk-csi-driver \
            --namespace kube-system

      - name: Apply StorageClass (default)
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          cat <<'EOF' | kubectl apply -f -
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: standard-rwo
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          provisioner: pd.csi.storage.gke.io
          parameters:
            type: pd-balanced
          reclaimPolicy: Delete
          volumeBindingMode: WaitForFirstConsumer
          EOF

  Artifact-connect-IAP:
    name: Artifact connect IAP
    runs-on: ubuntu-latest
    needs: terraform-apply-net
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Build IAP SSH command file
        env:
          PROJECT: ${{ vars.GCP_INFRA_PROJECT_ID }}
          ZONE: ${{ vars.GCP_INFRA_ZONE }}
        run: |
          cat > iap-ssh-command.txt <<'EOF'
          # Se sustituye <INSTANCE_NAME> y <USER> segun la VM.
          gcloud compute ssh <USER>@<INSTANCE_NAME> \
            --project ${PROJECT} \
            --zone ${ZONE} \
            --tunnel-through-iap \
            -- -o IdentitiesOnly=yes -o StrictHostKeyChecking=no
            EOF

      - name: Zip IAP SSH command file
        run: zip -j iap-ssh-command.zip iap-ssh-command.txt

      - name: Upload IAP SSH command artifact
        uses: actions/upload-artifact@v4
        with:
          name: iap-ssh-command
          path: iap-ssh-command.zip
          retention-days: 4
