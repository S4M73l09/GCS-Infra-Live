name: terraform-apply

on:
  push:
    branches: ["main"]
    paths:
      - "environments/**"
      - "modules/**"
      - "**/*.tf"
      - "**/*.tfvars"
      - "**/.tflint.hcl"
      - ".github/workflows/Apply-Live.yaml"
  workflow_dispatch:
    inputs:
      env_dir:
        description: 'Environment to apply (folder under environments/)'
        required: false
        default: 'dev'

permissions:
  contents: read
  id-token: write

# Un solo apply por rama (no cancelar si ya está en curso)
concurrency:
  group: apply-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ──────────────────────────────────────────────────────────────
  # 0) Detectar cambios y resolver directorio de entorno
  # ──────────────────────────────────────────────────────────────
  changes:
    name: Detect changes (Terraform/Workflow)
    runs-on: ubuntu-latest
    outputs:
      tf:  ${{ steps.filter.outputs.tf }}
      dir: ${{ steps.envdir.outputs.dir }}
      env: ${{ steps.envdir.outputs.env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tf:
              - 'environments/**'
              - '.github/workflows/Apply-Live.yaml'

      - name: Pick environment dir (safe)
        id: envdir
        shell: bash
        run: |
          set -Eeuo pipefail
          # Default seguro
          ENV="environments/dev"

          # Si se lanzó manual con input, úsalo
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.env_dir }}" ]]; then
            ENV="environments/${{ inputs.env_dir }}"
          else
            # Deducir primer entorno tocado respecto a main (no crítico, pero ayuda)
            changed_env="$(git diff --name-only "origin/main~1" "origin/main" 2>/dev/null \
              | awk -F/ '/^environments\//{print $1"/"$2}' | sort -u | head -n1 || true)"
            if [[ -n "$changed_env" ]]; then
              ENV="$changed_env"
            fi
          fi

          ENV_NAME="$(basename "$ENV")"
          echo "dir=$ENV" >> "$GITHUB_OUTPUT"
          echo "env=$ENV_NAME" >> "$GITHUB_OUTPUT"
          echo "Environment dir: $ENV ; env name: $ENV_NAME"

  # ──────────────────────────────────────────────────────────────
  # 1) PLAN en main (mismo código que vamos a aplicar)
  # ──────────────────────────────────────────────────────────────
  plan:
    name: Terraform Plan (main)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.tf == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform 1.9.7
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.7"
          terraform_wrapper: false

      - name: Google Auth (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account:          ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Cache TF plugins
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: tf-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-${{ runner.os }}-

      - name: Configure TF plugin cache
        run: |
          mkdir -p ~/.terraform.d
          echo 'plugin_cache_dir = "~/.terraform.d/plugin-cache"' > ~/.terraform.d/terraform.rc

      - name: Terraform Init (readonly lockfile)
        working-directory: ${{ needs.changes.outputs.dir }}
        run: terraform init -input=false -lockfile=readonly

      - name: Terraform Plan (save)
        id: planfile
        working-directory: ${{ needs.changes.outputs.dir }}
        shell: bash
        run: |
          set -e
          terraform plan -input=false -no-color -out=tfplan.bin
          terraform show -no-color tfplan.bin > tfplan.txt
          terraform show -json tfplan.bin > tfplan.json

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: |
            ${{ needs.changes.outputs.dir }}/tfplan.bin
            ${{ needs.changes.outputs.dir }}/tfplan.txt
            ${{ needs.changes.outputs.dir }}/tfplan.json
          retention-days: 7

  # ──────────────────────────────────────────────────────────────
  # 2) Gate de aprobación (Environment con Required reviewers)
  # ──────────────────────────────────────────────────────────────
  approve_gate:
    name: Await approval (${{ needs.changes.outputs.env }})
    runs-on: ubuntu-latest
    needs: plan
    if: needs.changes.outputs.tf == 'true'
    environment:
      name: ${{ needs.changes.outputs.env }}     # crea Environments (p.ej. prod/dev) con Required reviewers
      url: https://console.cloud.google.com/
    steps:
      - run: echo "Esperando aprobación del environment '${{ needs.changes.outputs.env }}'…"

  # ──────────────────────────────────────────────────────────────
  # 3) APPLY del tfplan generado en este mismo run
  # ──────────────────────────────────────────────────────────────
  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [changes, approve_gate]
    if: needs.changes.outputs.tf == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform 1.9.7
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.7"
          terraform_wrapper: false

      - name: Google Auth (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account:          ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ${{ needs.changes.outputs.dir }}

      - name: Terraform Init (reconfigure)
        working-directory: ${{ needs.changes.outputs.dir }}
        run: terraform init -input=false -lockfile=readonly -reconfigure

      - name: Terraform Apply (approved plan)
        working-directory: ${{ needs.changes.outputs.dir }}
        run: terraform apply -input=false -lock-timeout=5m tfplan.bin

  # ──────────────────────────────────────────────────────────────
  # 4) Publicar artefacto con el nombre del entorno
  # ──────────────────────────────────────────────────────────────
  publish-env-artifact:
    name: Publish env artifact
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.result == 'success' }}
    steps:
      - name: Save environment name
        run: echo "${{ needs.changes.outputs.env }}" > env.txt

      - name: Upload env artifact
        uses: actions/upload-artifact@v4
        with:
          name: applied-env
          path: env.txt
          retention-days: 1

