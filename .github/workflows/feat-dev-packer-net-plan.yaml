name: (feat/dev) Terraform plan + Packer validate (IAP)

on:
  push:
    branches:
      - "feat/dev"
    paths:
      - "environments/packer-dev/**"
      - ".github/workflows/feat-dev-packer-net-plan.yaml"
  pull_request:
    branches:
      - "feat/dev"
    paths:
      - "environments/packer-dev/**"
      - ".github/workflows/feat-dev-packer-net-plan.yaml"
  workflow_dispatch:

concurrency:
  group: packer-net-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform-net-plan:
    name: Terraform plan (packer networking)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        shell: bash
        working-directory: environments/packer-dev/terraform-net

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Si tu repo ya tiene auth OIDC a GCP, mete aquí tu bloque existente.
      # Ejemplo típico (descomentarlo y completar con tu provider/SA):
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      - name: Terraform init
        run: terraform init

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan (no apply)
        env:
          TF_VAR_project_id: ${{ vars.GCP_INFRA_PROJECT_ID }}
          TF_VAR_region:     ${{ vars.GCP_INFRA_REGION }}
          # Si también pasas vpc/subnet/cidr por variables del repo, añade aquí:
          TF_VAR_vpc_name:     ${{ vars.GCP_INFRA_NETWORK }}
          TF_VAR_subnet_name:  ${{ vars.GCP_INFRA_SUBNETWORK }}
          # TF_VAR_subnet_cidr: ${{ vars.GCP_INFRA_SUBNET_CIDR }}
          # TF_VAR_iap_ssh_tag:  ${{ vars.GCP_INFRA_IAP_SSH_TAG }}
        run: terraform plan -no-color

  packer-validate:
    name: Packer validate (IAP, no build)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    needs: terraform-net-plan

    defaults:
      run:
        shell: bash
        working-directory: environments/packer-dev/gcp-ubuntu-2204-iap

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Igual que arriba: usa tu auth OIDC real si lo tienes ya.
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_PACKER_SERVICE }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Packer init
        run: packer init .

      - name: Packer fmt (check)
        run: packer fmt -check .

      - name: Packer validate (no build)
        env:
          PKR_VAR_project_id:  ${{ vars.GCP_INFRA_PROJECT_ID }}
          PKR_VAR_region:      ${{ vars.GCP_INFRA_REGION }}
          PKR_VAR_zone:        ${{ vars.GCP_INFRA_ZONE }}
          PKR_VAR_service_account_email: ${{ vars.GCP_PACKER_SERVICE }}
          PKR_VAR_network:     ${{ vars.GCP_INFRA_NETWORK }}
          PKR_VAR_subnetwork:  ${{ vars.GCP_INFRA_SUBNETWORK }}
          # Opcionales si quieres sobreescribir defaults:
          # PKR_VAR_image_family: "ubuntu-2204-iap-family"
          # PKR_VAR_iap_ssh_tag:  "iap-ssh"
        run: packer validate .
